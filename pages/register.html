<!-- /pages/register.html -->
<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rejestracja — HappyDate</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
  <main class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
    <h1 class="text-2xl font-bold mb-6 text-center">Zarejestruj się w HappyDate</h1>

    <form id="register-form" class="space-y-4" autocomplete="off">
      <input type="text" id="full_name" placeholder="Imię i nazwisko" required class="w-full p-2 border rounded" />

      <input type="email" id="email" placeholder="Email" required class="w-full p-2 border rounded" />

      <div class="relative">
        <input type="password" id="password" placeholder="Hasło (min. 6 znaków)" minlength="6" required class="w-full p-2 border rounded pr-12" autocomplete="new-password" />
        <button type="button" id="toggle-pass" class="absolute inset-y-0 right-3 text-sm text-blue-600">Pokaż</button>
      </div>

      <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded transition">
        Zarejestruj się
      </button>
    </form>

    <div class="mt-6">
      <button id="signup-google" class="w-full border hover:bg-gray-50 py-2 rounded transition">
        Zarejestruj się przez Google
      </button>
    </div>

    <p class="mt-4 text-center text-sm">
      Masz już konto?
      <a href="/pages/login.html" class="text-blue-600 underline">Zaloguj się</a>
    </p>
  </main>

  <!-- Toast -->
  <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 hidden"></div>

  <script type="module">
    // UŻYJ JEDNEGO KLIENTA — z Twojego projektu
    import { supabase } from '/src/js/supabaseClient.js';

    const $ = (s, r=document) => r.querySelector(s);
    const toastBox = $('#toast');

    function notify(msg, type='ok') {
      toastBox.textContent = msg;
      toastBox.className = 'fixed top-4 left-1/2 -translate-x-1/2 z-50 px-4 py-2 rounded shadow ' +
        (type==='error' ? 'bg-red-600 text-white' : 'bg-green-600 text-white');
      toastBox.classList.remove('hidden');
      setTimeout(()=> toastBox.classList.add('hidden'), 2800);
    }

    function mapError(msg='') {
      const m = msg.toLowerCase();
      if (m.includes('invalid email')) return 'Podaj poprawny adres e-mail.';
      if (m.includes('password') && m.includes('length')) return 'Hasło musi mieć co najmniej 6 znaków.';
      if (m.includes('user already registered')) return 'Ten e-mail jest już zarejestrowany.';
      return msg || 'Wystąpił błąd. Spróbuj ponownie.';
    }

    // Pokaż/ukryj hasło
    $('#toggle-pass')?.addEventListener('click', () => {
      const inp = $('#password');
      const isPwd = inp.type === 'password';
      inp.type = isPwd ? 'text' : 'password';
      $('#toggle-pass').textContent = isPwd ? 'Ukryj' : 'Pokaż';
    });

    // Rejestracja email + hasło
    $('#register-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const full_name = $('#full_name').value.trim();
      const email = $('#email').value.trim();
      const password = $('#password').value;

      if (!full_name || !email || !password) {
        notify('Uzupełnij wszystkie pola.', 'error'); return;
      }

      try {
        const { data, error } = await supabase.auth.signUp({
          email, password,
          options: {
            data: { full_name },
            // po kliknięciu w link z e-maila Supabase wróci tu:
            emailRedirectTo: `${location.origin}/pages/login.html`
          }
        });

        if (error) return notify(mapError(error.message), 'error');

        // Jeśli e-mail confirmation WŁĄCZONE (domyślnie) — session będzie null:
        if (!data.session) {
          notify('Sprawdź skrzynkę i potwierdź adres e-mail ✉️');
          return;
        }

        // Jeśli e-mail confirmation WYŁĄCZONE — od razu mamy sesję:
        notify('Rejestracja zakończona sukcesem ✅');
        setTimeout(() => window.location.href = '/pages/survey.html', 1200);
      } catch (err) {
        console.error(err);
        notify('Ups! Coś poszło nie tak.', 'error');
      }
    });

    // Google OAuth (włącz w Supabase → Authentication → Providers)
    $('#signup-google')?.addEventListener('click', async () => {
      try {
        const { error } = await supabase.auth.signInWithOAuth({
          provider: 'google',
          options: { redirectTo: `${location.origin}/pages/dashboard.html` }
        });
        if (error) notify(mapError(error.message), 'error');
      } catch (e) {
        console.error(e);
        notify('Nie udało się rozpocząć logowania Google.', 'error');
      }
    });
  </script>
</body>
</html>
